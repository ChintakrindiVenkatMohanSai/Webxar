<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AR Viewer Pro</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

/* GLOBAL */
body{
margin:0;
overflow:hidden;
background:black;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
perspective:1600px;
}

/* CAMERA */
video{
position:fixed;
top:0;
left:0;
width:100vw;
height:100vh;
object-fit:cover;
filter:brightness(.95) contrast(1.05) saturate(1.05);
}

/* AR IMAGE */
.arImage{
position:fixed;
top:50%;
left:50%;
width:320px;
border-radius:24px;
cursor:grab;
touch-action:none;
transform-style:preserve-3d;
transition:transform .08s linear;

/* Realistic shadow */
box-shadow:
0 70px 200px rgba(0,0,0,.95),
0 25px 80px rgba(0,0,0,.85),
inset 0 0 20px rgba(255,255,255,.05);
}

/* IMAGE */
.arImage img{
width:100%;
border-radius:24px;
filter:contrast(1.08) brightness(.96);
}

/* Glass reflection */
.arImage::after{
content:"";
position:absolute;
top:0;
left:0;
width:100%;
height:100%;
border-radius:24px;
background:linear-gradient(
120deg,
rgba(255,255,255,.12),
transparent 40%
);
pointer-events:none;
}

/* CAPTURE BUTTON */
.captureBtn{
position:fixed;
bottom:30px;
left:50%;
transform:translateX(-50%);
background:rgba(20,20,30,.6);
backdrop-filter:blur(20px);
padding:16px 42px;
border-radius:50px;
color:white;
border:1px solid rgba(255,255,255,.25);
font-weight:600;
transition:.3s;
}

.captureBtn:hover{
background:#00bcd4;
box-shadow:0 10px 50px rgba(0,188,212,.7);
}

</style>
</head>

<body>

<video id="cam" autoplay playsinline muted></video>

<div class="arImage" id="plate">
<img src="{{ url_for('uploaded_file', filename=filename) }}">
</div>

<button class="captureBtn" onclick="captureAR()">
ðŸ“¸ Capture AR Photo
</button>

<script>

/* CAMERA START */
navigator.mediaDevices.getUserMedia({
video:{facingMode:"environment"}
}).then(stream=>{
cam.srcObject=stream;
}).catch(()=>{
alert("Camera permission required (HTTPS needed)");
});


let plate=document.getElementById("plate");
let x=0,y=0,scale=1,rot=0;
let startX,startY,startDist,startAngle;


/* MOUSE DRAG */
plate.onmousedown=e=>{
startX=e.clientX-x;
startY=e.clientY-y;

document.onmousemove=e=>{
x=e.clientX-startX;
y=e.clientY-startY;
update();
};

document.onmouseup=()=>document.onmousemove=null;
};


/* ZOOM */
plate.onwheel=e=>{
e.preventDefault();
scale+=e.deltaY*-0.001;
scale=Math.max(.3,Math.min(scale,3));
update();
};


/* TOUCH */
plate.addEventListener("touchstart",e=>{
if(e.touches.length==1){
startX=e.touches[0].clientX-x;
startY=e.touches[0].clientY-y;
}
if(e.touches.length==2){
startDist=getDist(e);
startAngle=getAngle(e);
}
});

plate.addEventListener("touchmove",e=>{
e.preventDefault();

if(e.touches.length==1){
x=e.touches[0].clientX-startX;
y=e.touches[0].clientY-startY;
}

if(e.touches.length==2){
let d=getDist(e);
scale*=d/startDist;
startDist=d;

let a=getAngle(e);
rot+=a-startAngle;
startAngle=a;
}

update();
});


/* CAMERA MOTION PARALLAX */
window.addEventListener("deviceorientation",e=>{
let tiltX=(e.beta||0)/8;
let tiltY=(e.gamma||0)/8;

plate.style.transform+=
` rotateX(${tiltX}deg) rotateY(${tiltY}deg)`;
});


function update(){

let tiltX=y*0.05;
let tiltY=-x*0.05;

plate.style.transform=`
translate(calc(-50% + ${x}px), calc(-50% + ${y}px))
scale(${scale})
rotate(${rot}deg)
rotateX(${tiltX}deg)
rotateY(${tiltY}deg)
`;

/* dynamic shadow */
plate.style.boxShadow=`
0 ${80+Math.abs(y)}px ${220+Math.abs(x)}px rgba(0,0,0,.95),
0 30px 90px rgba(0,0,0,.85),
inset 0 0 20px rgba(255,255,255,.05)
`;
}


/* HELPERS */
function getDist(e){
let dx=e.touches[0].clientX-e.touches[1].clientX;
let dy=e.touches[0].clientY-e.touches[1].clientY;
return Math.sqrt(dx*dx+dy*dy);
}

function getAngle(e){
let dx=e.touches[1].clientX-e.touches[0].clientX;
let dy=e.touches[1].clientY-e.touches[0].clientY;
return Math.atan2(dy,dx)*180/Math.PI;
}


/* CAPTURE */
function captureAR(){
html2canvas(document.body).then(canvas=>{
let link=document.createElement("a");
link.download="AR_Image.png";
link.href=canvas.toDataURL();
link.click();
});
}

</script>

</body>
</html>